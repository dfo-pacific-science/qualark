{
	"name": "df_qualark_testfishandsamples_to_silver",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_bronze_Qualark_YYYY_Test_Fishing_and_Sampling",
						"type": "DatasetReference"
					},
					"name": "bronzetestfisingandsamplingfile"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_silver_store_qualark_deaitledcatch",
						"type": "DatasetReference"
					},
					"name": "silverqualarktestfishingandsampling"
				},
				{
					"dataset": {
						"referenceName": "ds_error_sink_bronze",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "driftanddurationtimecast"
				},
				{
					"name": "renamingcastedcolums"
				},
				{
					"name": "conditionalintegritycheck"
				},
				{
					"name": "driftanddurationtimecast1"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "renamingcastedcolums2"
				}
			],
			"scriptLines": [
				"parameters{",
				"     p_run_id as string (\"\"),",
				"     error_sink_filename as string (\"error_file.csv\")",
				"}",
				"source(output(",
				"          drift_date as date,",
				"          drift_number as short,",
				"          location as string,",
				"          drift_start_time as string,",
				"          drift_end_time as string,",
				"          duration as string,",
				"          mesh_size as double,",
				"          adult_sockeye_retained as short,",
				"          jack_sockeye_retained as short,",
				"          adult_chinook_retained_ad_p as short,",
				"          adult_chinook_retained_ad_a as short,",
				"          adult_chinook_retained_ad_unk as short,",
				"          jack_chinook_retained_ad_p as short,",
				"          jack_chinook_retained_ad_a as short,",
				"          jack_chinook_retained_ad_unk as short,",
				"          coho_retained_ad_p as short,",
				"          coho_retained_ad_a as short,",
				"          coho_retained_ad_unk as short,",
				"          pink_retained as short,",
				"          chum_retained as short,",
				"          steelhead_retained as short,",
				"          adult_sockeye_released as short,",
				"          jack_sockeye_released as short,",
				"          adult_chinook_released_ad_p as short,",
				"          adult_chinook_released_ad_a as short,",
				"          adult_chinook_released_ad_unk as short,",
				"          jack_chinook_released_ad_p as short,",
				"          jack_chinook_released_ad_a as short,",
				"          jack_chinook_released_ad_unk as short,",
				"          coho_released_ad_p as short,",
				"          coho_released_ad_a as short,",
				"          coho_released_ad_unk as short,",
				"          pink_released as short,",
				"          chum_released as short,",
				"          steelhead_released as short,",
				"          comments as string,",
				"          total_adult_chinook_retained as short,",
				"          total_jack_chinook_retained as short,",
				"          total_adult_chinook_released as short,",
				"          total_jack_chinook_released as short,",
				"          total_coho_retained as short,",
				"          total_coho_released as short",
				"     ),",
				"     allowSchemaDrift: false,",
				"     validateSchema: true,",
				"     ignoreNoFilesFound: false) ~> bronzetestfisingandsamplingfile",
				"conditionalintegritycheck@valid derive(drift_start_time_converted = substring(drift_start_time, 12, 8),",
				"          drift_end_time_converted = substring(drift_end_time, 12, 8),",
				"          duration_converted = substring(duration, 12, 8)) ~> driftanddurationtimecast",
				"driftanddurationtimecast select(mapColumn(",
				"          drift_date,",
				"          drift_number,",
				"          location,",
				"          drift_start_time = drift_start_time_converted,",
				"          drift_end_time = drift_end_time_converted,",
				"          duration = duration_converted,",
				"          mesh_size,",
				"          adult_sockeye_retained,",
				"          jack_sockeye_retained,",
				"          adult_chinook_retained_ad_p,",
				"          adult_chinook_retained_ad_a,",
				"          adult_chinook_retained_ad_unk,",
				"          jack_chinook_retained_ad_p,",
				"          jack_chinook_retained_ad_a,",
				"          jack_chinook_retained_ad_unk,",
				"          coho_retained_ad_p,",
				"          coho_retained_ad_a,",
				"          coho_retained_ad_unk,",
				"          pink_retained,",
				"          chum_retained,",
				"          steelhead_retained,",
				"          adult_sockeye_released,",
				"          jack_sockeye_released,",
				"          adult_chinook_released_ad_p,",
				"          adult_chinook_released_ad_a,",
				"          adult_chinook_released_ad_unk,",
				"          jack_chinook_released_ad_p,",
				"          jack_chinook_released_ad_a,",
				"          jack_chinook_released_ad_unk,",
				"          coho_released_ad_p,",
				"          coho_released_ad_a,",
				"          coho_released_ad_unk,",
				"          pink_released,",
				"          chum_released,",
				"          steelhead_released,",
				"          comments,",
				"          total_adult_chinook_retained,",
				"          total_jack_chinook_retained,",
				"          total_adult_chinook_released,",
				"          total_jack_chinook_released,",
				"          total_coho_retained,",
				"          total_coho_released",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> renamingcastedcolums",
				"derivedColumn1 split(reason_code == 'None',",
				"     disjoint: false) ~> conditionalintegritycheck@(valid, invalid)",
				"conditionalintegritycheck@invalid derive(drift_start_time_converted = iif(isNull(drift_start_time) || length(drift_start_time) == 0, \"\", iif(length(drift_start_time) < 20, '00:00', substring(drift_start_time, 12, 8))),",
				"          drift_end_time_converted = iif(isNull(drift_end_time) || length(drift_end_time) == 0, \"\", iif(length(drift_end_time) < 20, '00:00', substring(drift_end_time, 12, 8))),",
				"          duration_converted = iif(isNull(duration) || length(duration) == 0, \"\", iif(length(duration) < 20, '00:00', substring(duration, 12, 8))),",
				"          error_timestamp = fromUTC(currentUTC('yyyyMMdd-HHmmss'),'Pacific Standard Time')) ~> driftanddurationtimecast1",
				"bronzetestfisingandsamplingfile derive(reason_code = iif(\r",
				"    !isNull(drift_date) &&\r",
				"    drift_number > 0 &&\r",
				"    mesh_size >= 0 &&\r",
				"    !isNull(location) && location != '' &&\r",
				"    minute(toTimestamp(duration, 'yyyy-MM-dd\\'T\\'HH:mm:ss')) > 0 &&\r",
				"    toTimestamp(drift_start_time, 'yyyy-MM-dd\\'T\\'HH:mm:ss') < toTimestamp(drift_end_time, 'yyyy-MM-dd\\'T\\'HH:mm:ss') &&\r",
				"    adult_sockeye_retained >= 0 &&\r",
				"    jack_sockeye_retained >= 0 &&\r",
				"    adult_chinook_retained_ad_p >= 0 &&\r",
				"    adult_chinook_retained_ad_a >= 0 &&\r",
				"    adult_chinook_retained_ad_unk >= 0 &&\r",
				"    jack_chinook_retained_ad_p >= 0 &&\r",
				"    jack_chinook_retained_ad_a >= 0 &&\r",
				"    jack_chinook_retained_ad_unk >= 0 &&\r",
				"    coho_retained_ad_p >= 0 &&\r",
				"    coho_retained_ad_a >= 0 &&\r",
				"    coho_retained_ad_unk >= 0 &&\r",
				"    pink_retained >= 0 &&\r",
				"    chum_retained >= 0 &&\r",
				"    steelhead_retained >= 0 &&\r",
				"    adult_sockeye_released >= 0 &&\r",
				"    jack_sockeye_released >= 0 &&\r",
				"    adult_chinook_released_ad_p >= 0 &&\r",
				"    adult_chinook_released_ad_a >= 0 &&\r",
				"    adult_chinook_released_ad_unk >= 0 &&\r",
				"    jack_chinook_released_ad_p >= 0 &&\r",
				"    jack_chinook_released_ad_a >= 0 &&\r",
				"    jack_chinook_released_ad_unk >= 0 &&\r",
				"    coho_released_ad_p >= 0 &&\r",
				"    coho_released_ad_a >= 0 &&\r",
				"    coho_released_ad_unk >= 0 &&\r",
				"    pink_released >= 0 &&\r",
				"    chum_released >= 0 &&\r",
				"    steelhead_released >= 0 &&\r",
				"    total_adult_chinook_retained >= 0 &&\r",
				"    total_jack_chinook_retained >= 0 &&\r",
				"    total_adult_chinook_released >= 0 &&\r",
				"    total_jack_chinook_released >= 0 &&\r",
				"    total_coho_retained >= 0 &&\r",
				"    total_coho_released >= 0,\r",
				"    'None',\r",
				"    'Invalid row: missing or out-of-range field(s)'\r",
				"),",
				"          pipeline_run_id = $p_run_id) ~> derivedColumn1",
				"driftanddurationtimecast1 select(mapColumn(",
				"          drift_date,",
				"          drift_number,",
				"          location,",
				"          drift_start_time = drift_start_time_converted,",
				"          drift_end_time = drift_end_time_converted,",
				"          duration = duration_converted,",
				"          mesh_size,",
				"          adult_sockeye_retained,",
				"          jack_sockeye_retained,",
				"          adult_chinook_retained_ad_p,",
				"          adult_chinook_retained_ad_a,",
				"          adult_chinook_retained_ad_unk,",
				"          jack_chinook_retained_ad_p,",
				"          jack_chinook_retained_ad_a,",
				"          jack_chinook_retained_ad_unk,",
				"          coho_retained_ad_p,",
				"          coho_retained_ad_a,",
				"          coho_retained_ad_unk,",
				"          pink_retained,",
				"          chum_retained,",
				"          steelhead_retained,",
				"          adult_sockeye_released,",
				"          jack_sockeye_released,",
				"          adult_chinook_released_ad_p,",
				"          adult_chinook_released_ad_a,",
				"          adult_chinook_released_ad_unk,",
				"          jack_chinook_released_ad_p,",
				"          jack_chinook_released_ad_a,",
				"          jack_chinook_released_ad_unk,",
				"          coho_released_ad_p,",
				"          coho_released_ad_a,",
				"          coho_released_ad_unk,",
				"          pink_released,",
				"          chum_released,",
				"          steelhead_released,",
				"          comments,",
				"          total_adult_chinook_retained,",
				"          total_jack_chinook_retained,",
				"          total_adult_chinook_released,",
				"          total_jack_chinook_released,",
				"          total_coho_retained,",
				"          total_coho_released,",
				"          error_details = reason_code,",
				"          error_timestamp,",
				"          pipeline_run_id",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> renamingcastedcolums2",
				"renamingcastedcolums sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:['qualark_testfishing_and_sampling.csv'],",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     mapColumn(",
				"          drift_date,",
				"          drift_number,",
				"          location,",
				"          drift_start_time,",
				"          drift_end_time,",
				"          duration,",
				"          mesh_size,",
				"          adult_sockeye_retained,",
				"          jack_sockeye_retained,",
				"          adult_chinook_retained_ad_p,",
				"          adult_chinook_retained_ad_a,",
				"          adult_chinook_retained_ad_unk,",
				"          jack_chinook_retained_ad_p,",
				"          jack_chinook_retained_ad_a,",
				"          jack_chinook_retained_ad_unk,",
				"          coho_retained_ad_p,",
				"          coho_retained_ad_a,",
				"          coho_retained_ad_unk,",
				"          pink_retained,",
				"          chum_retained,",
				"          steelhead_retained,",
				"          adult_sockeye_released,",
				"          jack_sockeye_released,",
				"          adult_chinook_released_ad_p,",
				"          adult_chinook_released_ad_a,",
				"          adult_chinook_released_ad_unk,",
				"          jack_chinook_released_ad_p,",
				"          jack_chinook_released_ad_a,",
				"          jack_chinook_released_ad_unk,",
				"          coho_released_ad_p,",
				"          coho_released_ad_a,",
				"          coho_released_ad_unk,",
				"          pink_released,",
				"          chum_released,",
				"          steelhead_released,",
				"          comments,",
				"          total_adult_chinook_retained,",
				"          total_jack_chinook_retained,",
				"          total_adult_chinook_released,",
				"          total_jack_chinook_released,",
				"          total_coho_retained,",
				"          total_coho_released",
				"     ),",
				"     partitionBy('hash', 1)) ~> silverqualarktestfishingandsampling",
				"renamingcastedcolums2 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:[($error_sink_filename)],",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     partitionBy('hash', 1)) ~> sink1"
			]
		}
	}
}